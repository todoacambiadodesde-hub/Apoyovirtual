<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ materia.nombre }} - Examen</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --primary: #2d3436;
            --accent: #0984e3;
            --success: #00b894;
            --error: #d63031;
            --text-muted: #636e72;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container { 
            width: 90%; 
            max-width: 550px; 
            background: var(--card-bg); 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            text-align: center;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .timer { color: var(--error); font-weight: 600; background: #fff5f5; padding: 5px 12px; border-radius: 8px; }

        .enunciado { font-size: 1.2rem; margin: 30px 0; min-height: 60px; line-height: 1.6; }

        .input-mate { 
            width: 100%; padding: 15px; border: 1.5px solid #e1e4e8;
            border-radius: 12px; font-size: 1rem; box-sizing: border-box;
        }

        .opciones-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }

        .btn-opt { 
            padding: 15px; border: 1.5px solid #f1f2f6; background: #f1f2f6;
            border-radius: 12px; cursor: pointer; text-align: left; font-size: 1rem;
        }

        .btn-opt:hover { background: var(--accent); color: white; }

        .btn-enviar { 
            background: var(--primary); color: white; border: none; 
            padding: 18px; width: 100%; border-radius: 12px; 
            margin-top: 20px; cursor: pointer; font-weight: 600;
        }

        /* BOTÓN DE FINALIZAR MEJORADO */
        .btn-terminar { 
            background: var(--success); color: white; border: none; 
            padding: 18px; width: 100%; border-radius: 12px; 
            margin-top: 20px; cursor: pointer; font-weight: 600; 
            display: none; /* Se activa por JS */
        }

        .abandonar { margin-top: 25px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-info">
        <span style="color: var(--text-muted);">Pregunta <span id="num_pregunta">1</span>/20</span>
        <div class="timer" id="clock">03:00</div>
    </div>
    
    <h2 style="margin:0;">{{ materia.nombre }}</h2>
    
    <div class="enunciado" id="area-enunciado">
        {{ pregunta.enunciado | safe }}
    </div>

    <div id="contenedor-respuestas">
        {% if materia.es_exacta %}
            <input type="text" id="resp_abierta" class="input-mate" placeholder="Tu respuesta (ej: 4/x, x**2)..." autofocus>
            <button class="btn-enviar" onclick="enviarRespuesta(document.getElementById('resp_abierta').value)">Confirmar</button>
        {% else %}
            <div class="opciones-grid">
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_a }}')">{{ pregunta.opcion_a }}</button>
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_b }}')">{{ pregunta.opcion_b }}</button>
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_c }}')">{{ pregunta.opcion_c }}</button>
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_d }}')">{{ pregunta.opcion_d }}</button>
            </div>
        {% endif %}
    </div>

    <button id="btn_finalizar" class="btn-terminar" onclick="irAResultados()">
        Ver Resultados del Examen
    </button>

    <button class="abandonar" onclick="abandonar()">— Abandonar —</button>
</div>

<script>
    let historial = JSON.parse(localStorage.getItem('respuestas_examen') || '[]');
    document.getElementById('num_pregunta').innerText = historial.length + 1;

    // Reloj
    let tiempo = 180;
    const tInterval = setInterval(() => {
        let m = Math.floor(tiempo / 60);
        let s = tiempo % 60;
        document.getElementById('clock').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        if (tiempo <= 0) { clearInterval(tInterval); enviarRespuesta("TIEMPO AGOTADO"); }
        tiempo--;
    }, 1000);

    function enviarRespuesta(valor) {
        if(!valor && valor !== "TIEMPO AGOTADO") return;
        
        // Bloqueo visual
        document.getElementById('contenedor-respuestas').style.opacity = "0.4";
        document.getElementById('contenedor-respuestas').style.pointerEvents = "none";

        fetch('/verificar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: {{ pregunta.id }}, respuesta: valor })
        })
        .then(res => res.json())
        .then(data => {
            // Notificación
            const fed = document.createElement('div');
            fed.innerText = data.msg;
            Object.assign(fed.style, {
                position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
                padding: '15px 30px', borderRadius: '12px', color: 'white', zIndex: '1000',
                background: data.status === "ok" ? '#00b894' : '#d63031', fontWeight: 'bold'
            });
            document.body.appendChild(fed);

            historial.push({ id: {{ pregunta.id }}, respuesta: valor });
            localStorage.setItem('respuestas_examen', JSON.stringify(historial));

            setTimeout(() => {
                fed.remove();
                if (historial.length >= 20) {
                    clearInterval(tInterval);
                    document.getElementById('area-enunciado').innerHTML = "<h3>¡Examen Finalizado!</h3>";
                    document.getElementById('contenedor-respuestas').style.display = 'none';
                    document.getElementById('btn_finalizar').style.display = 'block';
                } else {
                    location.reload();
                }
            }, 1500);
        });
    }

    function irAResultados() {
        fetch('/finalizar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ respuestas: historial })
        })
        .then(res => res.json())
        .then(data => {
            localStorage.removeItem('respuestas_examen');
            window.location.href = data.redirect;
        });
    }

    function abandonar() {
        if(confirm("¿Salir?")) {
            localStorage.removeItem('respuestas_examen');
            window.location.href = '/dashboard';
        }
    }
</script>
</body>
</html>

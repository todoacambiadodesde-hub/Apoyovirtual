<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Examen - {{ materia.nombre }}</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 40px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; position: relative; }
        .timer { color: #d93025; font-size: 24px; font-weight: bold; text-align: right; margin-bottom: 10px; }
        .progreso { text-align: left; color: #666; font-weight: bold; margin-bottom: 20px; }
        .opciones-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .btn-opt { padding: 15px; border: 2px solid #1a73e8; background: white; color: #1a73e8; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-opt:hover { background: #1a73e8; color: white; }
        .input-mate { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        .btn-enviar { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; margin-top: 20px; cursor: pointer; font-size: 16px; font-weight: bold; position: relative; z-index: 10; }
        
        /* Ajuste para asegurar que el botón de terminar sea cliqueable */
        .btn-terminar { background: #28a745; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold; display: none; position: relative; z-index: 20; }
    </style>
</head>
<body>

<div class="card">
    <div class="timer">Tiempo: <span id="clock">--:--</span></div>
    <p class="progreso">Pregunta <span id="num_pregunta">1</span> de 20</p>
    
    <h2>{{ materia.nombre }}</h2>
    <hr>
    
    <div style="font-size: 20px; margin: 25px 0; line-height: 1.5;">
        {{ pregunta.enunciado | safe }}
    </div>

    <div id="contenedor-respuestas">
        {% if materia.es_exacta %}
            <input type="text" id="resp_abierta" class="input-mate" placeholder="Tu respuesta (ej: 2*x + 5)">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">* Potencia: ** | Fracción: /</p>
            <button class="btn-enviar" onclick="enviarRespuesta(document.getElementById('resp_abierta').value)">Enviar Respuesta</button>
        {% else %}
            <div class="opciones-grid">
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_a }}')">A) {{ pregunta.opcion_a }}</button>
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_b }}')">B) {{ pregunta.opcion_b }}</button>
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_c }}')">C) {{ pregunta.opcion_c }}</button>
                <button class="btn-opt" onclick="enviarRespuesta('{{ pregunta.opcion_d }}')">D) {{ pregunta.opcion_d }}</button>
            </div>
        {% endif %}
    </div>

    <button id="btn_finalizar" class="btn-terminar" onclick="irAResultados()">Ver Resultados</button>

    <button style="margin-top:40px; background:#5f6368;" class="btn-enviar" onclick="abandonar()">Abandonar Examen</button>
</div>

<script>
    // --- LÓGICA DE PROGRESO ---
    let historial = JSON.parse(localStorage.getItem('respuestas_examen') || '[]');
    
    // Evitamos que el contador visual pase de 20
    let numActual = historial.length + 1;
    document.getElementById('num_pregunta').innerText = numActual > 20 ? 20 : numActual;

    // --- CRONÓMETRO DE 3 MINUTOS ---
    let tiempoRestante = 90; 
    const clockDisplay = document.getElementById('clock');
    
    const timerInterval = setInterval(() => {
        let min = Math.floor(tiempoRestante / 60);
        let sec = tiempoRestante % 60;
        clockDisplay.innerText = `${min}:${sec < 10 ? '0' : ''}${sec}`;
        
        if (tiempoRestante <= 0) {
            clearInterval(timerInterval);
            alert("¡Se acabó el tiempo para esta pregunta!");
            enviarRespuesta("TIEMPO AGOTADO"); 
        }
        tiempoRestante--;
    }, 1000);

    // --- FUNCIÓN ENVIAR CORREGIDA ---
    function enviarRespuesta(valor) {
        if(!valor && valor !== "TIEMPO AGOTADO") return alert("Escribe o selecciona una respuesta");
        
        historial.push({ id: {{ pregunta.id }}, respuesta: valor });
        localStorage.setItem('respuestas_examen', JSON.stringify(historial));

        fetch('/verificar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: {{ pregunta.id }}, respuesta: valor })
        })
        .then(res => res.json())
        .then(data => {
            if (historial.length >= 20) {
                // FINAL DEL EXAMEN
                clearInterval(timerInterval); // Detenemos el reloj inmediatamente
                
                // Ocultamos el examen para que no bloquee los clics
                document.getElementById('contenedor-respuestas').style.display = 'none';
                
                // Mostramos el botón de resultados con alta prioridad
                let btnFin = document.getElementById('btn_finalizar');
                btnFin.style.display = 'block';
                
                if(valor !== "TIEMPO AGOTADO") alert(data.msg + "\nExamen completado.");
            } else {
                // SIGUIENTE PREGUNTA
                if(valor !== "TIEMPO AGOTADO") alert(data.msg);
                location.reload(); 
            }
        });
    }

    function irAResultados() {
        fetch('/finalizar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ respuestas: historial })
        })
        .then(res => res.json())
        .then(data => {
            localStorage.removeItem('respuestas_examen');
            window.location.href = data.redirect;
        });
    }

    function abandonar() {
        if(confirm("¿Estás seguro? Se perderá tu progreso.")) {
            localStorage.removeItem('respuestas_examen');
            window.location.href = '/dashboard';
        }
    }
</script>

</body>
</html>
